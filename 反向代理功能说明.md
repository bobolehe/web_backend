# 反向代理功能说明

## 功能概述

系统现在支持完整的反向代理功能，克隆的网站的所有请求都会：
1. **静态文件**（HTML、CSS、JS、图片等）→ 从本地服务器返回
2. **API 请求**（数据接口）→ 代理转发到原始服务器

## 工作原理

### 1. 克隆阶段
- 使用 Playwright 访问源网站
- 获取渲染后的 HTML 内容
- **替换所有绝对 URL 为相对路径**
- 移除 `<base>` 标签
- 保存到本地

### 2. 服务阶段
每个克隆项目启动一个支持反向代理的 HTTP 服务器：

```
客户端请求
    ↓
本地服务器 (127.0.0.1:端口)
    ↓
判断请求类型
    ├─ 静态文件 → 返回本地文件
    └─ API 请求 → 代理到原始服务器
```

### 3. 请求处理逻辑

**静态文件请求**（直接返回本地文件）：
- `/` 或 `/index.html`
- 任何存在于本地的文件（`.html`, `.css`, `.js`, `.jpg`, `.png` 等）

**API 请求**（代理到原始服务器）：
- `/api/*` 等不存在于本地的路径
- POST、PUT、DELETE 等非 GET 请求
- 所有动态数据请求

## 示例

假设克隆 `https://app.apifox.com/user/login`：

### 原始网站的请求
```javascript
// 页面加载
GET https://app.apifox.com/user/login

// 加载样式
GET https://app.apifox.com/css/style.css

// API 请求
POST https://app.apifox.com/api/auth/login
```

### 克隆后的请求
```javascript
// 页面加载（本地）
GET http://127.0.0.1:7754/

// 加载样式（本地）
GET http://127.0.0.1:7754/css/style.css

// API 请求（代理到原始服务器）
POST http://127.0.0.1:7754/api/auth/login
  ↓ 代理转发
POST https://app.apifox.com/api/auth/login
```

## 优势

1. **完全本地化的外观**
   - HTML、CSS、JS 文件从本地加载
   - 快速响应，不依赖原始服务器的静态资源

2. **保持功能完整**
   - API 请求自动转发到原始服务器
   - 登录、提交表单等功能正常工作
   - 保留所有动态功能

3. **透明代理**
   - 用户感觉像在使用本地应用
   - 所有请求都发送到 `127.0.0.1:端口`
   - 自动处理请求头和响应头

4. **支持所有 HTTP 方法**
   - GET、POST、PUT、DELETE 等
   - 自动转发请求体和请求头
   - 保持会话状态（Cookie）

## 技术细节

### URL 替换
克隆时会替换：
```html
<!-- 原始 -->
<script src="https://app.apifox.com/js/app.js"></script>
<link href="https://app.apifox.com/css/style.css" rel="stylesheet">

<!-- 替换后 -->
<script src="/js/app.js"></script>
<link href="/css/style.css" rel="stylesheet">
```

### 代理请求头
代理时会：
- ✅ 复制原始请求头（User-Agent、Cookie、Authorization 等）
- ✅ 转发请求体（POST/PUT 数据）
- ✅ 保持响应头（Content-Type、Set-Cookie 等）
- ❌ 跳过不需要的头（Host、Connection、Transfer-Encoding）

### 错误处理
- HTTP 错误（404、500 等）→ 返回原始错误码
- 网络错误 → 返回 502 Bad Gateway
- 超时设置：30 秒

## 使用场景

### ✅ 适用场景
- 本地测试和开发
- 保存网站快照（包括功能）
- 绕过网络限制（通过本地访问）
- 学习和研究网站结构
- 自定义域名访问

### ⚠️ 注意事项
- 需要网络连接到原始服务器（用于 API 请求）
- 可能违反原始网站的服务条款
- 某些网站可能有反爬虫或反代理机制
- HTTPS 证书验证可能导致问题

### ❌ 不适用场景
- 完全离线使用（API 仍需网络）
- 商业用途（可能侵权）
- 需要修改 API 响应的场景

## 配置

### 端口设置
在项目的"域名"字段中指定端口：
```
127.0.0.1:7754  → 使用端口 7754
127.0.0.1:8080  → 使用端口 8080
```

如果端口被占用，系统会自动分配 7000-9000 范围内的可用端口。

### 查看日志
所有代理请求都会记录在日志中：
```
[Project xxx] Proxied POST /api/login -> https://app.apifox.com/api/login
[Project xxx] 127.0.0.1 - - [10/Feb/2026 18:00:00] "POST /api/login HTTP/1.1" 200 -
```

## 故障排除

### 问题：API 请求失败
**可能原因**：
- 原始服务器不可访问
- 网络连接问题
- 原始服务器有反代理机制

**解决方法**：
- 检查网络连接
- 查看日志中的错误信息
- 尝试直接访问原始 API

### 问题：静态资源加载失败
**可能原因**：
- 文件未正确克隆
- 路径替换不完整

**解决方法**：
- 重新克隆项目
- 检查本地文件是否存在
- 查看浏览器控制台的错误信息

### 问题：登录状态丢失
**可能原因**：
- Cookie 域名不匹配
- Session 过期

**解决方法**：
- 重新登录
- 检查 Cookie 设置
- 某些网站可能需要特殊处理

## 总结

反向代理功能让克隆的网站：
- ✅ 外观完全本地化（快速加载）
- ✅ 功能完全保留（API 自动转发）
- ✅ 用户体验一致（透明代理）
- ⚠️ 仍需网络连接（用于 API）
- ⚠️ 注意法律和道德问题
