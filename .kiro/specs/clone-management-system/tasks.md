# 实施计划: 克隆管理系统

## 概述

本实施计划将克隆管理系统的设计转换为可执行的开发任务。系统使用 Python + FastAPI 构建后端 API，使用 Playwright 进行网页克隆，使用 PostgreSQL 作为数据库，前端使用 React 构建管理界面。

## 任务列表

- [x] 1. 项目初始化和基础设施搭建
  - 创建项目目录结构
  - 配置 Python 虚拟环境和依赖管理（requirements.txt 或 pyproject.toml）
  - 安装核心依赖：FastAPI、Playwright、SQLAlchemy、Alembic、Pydantic
  - 配置数据库连接和环境变量管理
  - 设置日志配置
  - _需求: 10.1, 10.4_

- [ ] 2. 数据库模型和迁移
  - [x] 2.1 定义 SQLAlchemy 数据模型
    - 创建 Project 模型（id, name, source_url, source_screenshot, domain, status, content_path, error_message, created_at, updated_at）
    - 创建 AccessLog 模型（id, project_id, domain, ip, user_agent, path, referer, timestamp）
    - 创建 SystemConfig 模型（key, value, description, updated_at）
    - 创建 FeatureFlag 模型（name, enabled, description, updated_at）
    - 创建 AdminUser 模型（id, username, password_hash, email, created_at, last_login）
    - _需求: 10.1_

  - [ ] 2.2 编写属性测试验证数据模型
    - **属性 20: 数据持久化往返一致性**
    - **验证需求: 10.1, 10.2, 10.3**

  - [x] 2.3 创建数据库迁移脚本
    - 使用 Alembic 创建初始迁移
    - 添加索引和外键约束
    - _需求: 10.1_

- [ ] 3. 认证和授权系统
  - [x] 3.1 实现用户认证服务
    - 实现密码哈希和验证（使用 bcrypt）
    - 实现 JWT token 生成和验证
    - 创建登录、登出、获取当前用户接口
    - _需求: 9.1, 9.2, 9.3, 9.5_

  - [ ] 3.2 编写属性测试验证认证逻辑
    - **属性 18: 认证验证正确性**
    - **验证需求: 9.2, 9.3**

  - [ ] 3.3 实现认证中间件
    - 创建 JWT 验证中间件
    - 实现会话超时检查
    - 实现未认证请求拦截
    - _需求: 9.1, 9.4_

  - [ ] 3.4 编写属性测试验证认证拦截

    - **属性 17: 认证拦截正确性**
    - **验证需求: 9.1**


  - [ ] 3.5 编写属性测试验证会话管理

    - **属性 19: 会话管理正确性**
    - **验证需求: 9.4, 9.5**

- [ ] 4. 克隆项目管理 API
  - [x] 4.1 实现项目 CRUD 接口
    - GET /api/projects - 获取项目列表
    - POST /api/projects - 创建新项目
    - GET /api/projects/{id} - 获取项目详情
    - PUT /api/projects/{id} - 更新项目
    - DELETE /api/projects/{id} - 删除项目
    - _需求: 1.1, 1.5, 2.1, 2.3_

  - [ ] 4.2 编写属性测试验证项目创建

    - **属性 1: 项目创建完整性**
    - **验证需求: 1.1, 1.3**
    
  - [ ] 4.3 编写属性测试验证项目更新

    - **属性 4: 项目更新保持一致性**
    - **验证需求: 2.1**

  - [ ] 4.4 编写属性测试验证项目删除

    - **属性 5: 删除操作完整性**
    - **验证需求: 2.3, 2.4**

  - [ ] 4.5 实现输入验证
    - 验证 URL 格式
    - 验证域名格式
    - 验证必填字段
    - _需求: 1.1_

- [ ] 5. Playwright 克隆服务
  - [ ] 5.1 实现克隆服务核心功能
    - 初始化 Playwright 浏览器实例
    - 实现页面访问和等待逻辑
    - 提取 HTML 内容
    - 下载 CSS、JavaScript 和资源文件
    - 重写相对路径为绝对路径
    - 保存克隆内容到文件系统
    - _需求: 1.2_

  - [ ] 5.2 实现克隆任务状态管理
    - 更新项目状态为 cloning
    - 成功时更新为 completed 并保存 content_path
    - 失败时更新为 failed 并记录 error_message
    - _需求: 3.1, 3.2, 3.3_

  - [ ] 5.3 编写属性测试验证克隆触发

    - **属性 2: 克隆触发一致性**
    - **验证需求: 1.2, 2.2**


  - [ ]* 5.4 编写属性测试验证状态转换
    - **属性 6: 状态转换正确性**
    - **验证需求: 3.1, 3.2, 3.3, 3.4**

  - [ ] 5.5 实现克隆错误处理
    - 捕获网络超时异常
    - 捕获页面加载失败异常
    - 捕获资源下载失败异常
    - 记录详细错误信息
    - _需求: 3.3, 3.4_

  - [ ] 5.6 实现克隆重试接口
    - POST /api/projects/{id}/retry - 重试失败的克隆任务
    - 重置项目状态并重新执行克隆
    - _需求: 3.5_

  - [ ] 5.7 编写属性测试验证重试功能

    - **属性 7: 重试功能正确性**
    - **验证需求: 3.5**

- [ ] 6. 检查点 - 确保核心功能正常
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 域名路由服务
  - [ ] 7.1 实现域名路由中间件
    - 从请求中提取域名
    - 根据域名查找对应的项目
    - 提供克隆页面内容
    - 处理静态资源请求
    - _需求: 1.4_

  - [ ] 7.2 编写属性测试验证域名路由

    - **属性 3: 域名路由正确性**
    - **验证需求: 1.4**

  - [ ] 7.3 实现 404 错误处理
    - 域名未绑定时返回 404
    - 内容文件不存在时返回 404
    - _需求: 1.4_

- [ ] 8. 访问日志系统
  - [ ] 8.1 实现访问日志记录
    - 在域名路由中间件中记录访问
    - 提取 IP 地址、User-Agent、路径、Referer
    - 异步写入数据库
    - _需求: 4.1_

  - [ ] 8.2 编写属性测试验证日志记录

    - **属性 8: 访问日志完整性**
    - **验证需求: 4.1**

  - [ ] 8.3 实现访问日志查询 API
    - GET /api/logs - 获取日志列表
    - 支持按域名过滤
    - 支持按时间范围过滤
    - 支持分页
    - _需求: 4.2, 4.3, 4.4_

  - [ ] 8.4 编写属性测试验证日志过滤

    - **属性 9: 日志过滤正确性**
    - **验证需求: 4.3, 4.4**

  - [ ] 8.5 实现日志清理功能
    - 创建定时任务清理过期日志
    - 根据配置的保留天数删除旧日志
    - _需求: 4.5_

  - [ ] 8.6 编写属性测试验证日志清理

    - **属性 10: 日志清理正确性**
    - **验证需求: 4.5**

- [ ] 9. 访问统计分析
  - [ ] 9.1 实现统计查询 API
    - GET /api/logs/stats - 获取统计数据
    - 计算总访问次数
    - 计算独立访问者数量（基于 IP）
    - 按域名分组统计
    - 按日期分组统计（趋势数据）
    - _需求: 5.1, 5.2, 5.3_

  - [ ] 9.2 编写属性测试验证统计准确性

    - **属性 11: 访问统计准确性**
    - **验证需求: 5.1, 5.2**

  - [ ] 9.3 实现地理位置分析（可选）
    - 集成 IP 地理位置库（如 GeoIP2）
    - 统计访问者地理分布
    - _需求: 5.4_

- [ ] 10. 系统配置管理
  - [ ] 10.1 实现配置 CRUD API
    - GET /api/config - 获取所有配置
    - PUT /api/config - 更新配置
    - _需求: 6.1, 6.4_

  - [ ] 10.2 实现配置验证逻辑
    - 验证邮件端口范围
    - 验证日志保留天数
    - 验证超时时间
    - _需求: 6.2, 6.3_

  - [ ] 10.3 编写属性测试验证配置管理

    - **属性 12: 配置验证和更新正确性**
    - **验证需求: 6.2, 6.3, 6.4, 6.5**

  - [ ] 10.4 实现配置热加载
    - 配置更新后立即生效
    - 不需要重启服务
    - _需求: 6.4_

- [ ] 11. 邮件通知系统
  - [ ] 11.1 实现邮件服务
    - 配置 SMTP 客户端（使用 smtplib 或 aiosmtplib）
    - 实现邮件发送功能
    - 创建邮件模板（克隆完成、克隆失败）
    - _需求: 7.1, 7.5_

  - [ ] 11.2 实现 SMTP 配置验证
    - POST /api/config/email/test - 测试邮件配置
    - 验证 SMTP 连接
    - 发送测试邮件
    - _需求: 7.2, 7.3, 7.4_

  - [ ] 11.3 编写属性测试验证 SMTP 配置

    - **属性 13: SMTP 配置验证正确性**
    - **验证需求: 7.2, 7.3, 7.4**

  - [ ] 11.4 集成邮件通知到克隆服务
    - 克隆完成时发送通知
    - 克隆失败时发送通知
    - 检查邮件功能是否启用
    - _需求: 7.5_

  - [ ] 11.5 编写属性测试验证邮件通知触发

    - **属性 14: 邮件通知触发正确性**
    - **验证需求: 7.5**

- [ ] 12. 功能开关系统
  - [ ] 12.1 实现功能开关 API
    - GET /api/features - 获取所有功能开关
    - PUT /api/features/{name} - 切换功能开关
    - _需求: 8.1, 8.2_

  - [ ] 12.2 实现功能开关逻辑
    - 在邮件服务中检查邮件通知开关
    - 在日志服务中检查日志记录开关
    - _需求: 8.3, 8.4_

  - [ ] 12.3 编写属性测试验证功能开关

    - **属性 15: 功能开关生效性**
    - **验证需求: 8.2, 8.3, 8.4**

  - [ ] 12.4 实现功能开关审计日志
    - 记录开关变更操作
    - 记录操作时间和操作者
    - _需求: 8.5_

  - [ ] 12.5 编写属性测试验证审计日志

    - **属性 16: 功能开关审计日志**
    - **验证需求: 8.5**

- [ ] 13. 检查点 - 确保所有后端功能完成
  - 确保所有测试通过，如有问题请询问用户

- [ ] 14. 前端管理界面（React）
  - [ ] 14.1 创建 React 项目
    - 使用 Create React App 或 Vite 初始化项目
    - 安装依赖：React Router、Axios、Ant Design 或 Material-UI
    - 配置 API 基础 URL
    - _需求: 1.1_

  - [ ] 14.2 实现登录页面
    - 创建登录表单
    - 实现登录逻辑
    - 保存 JWT token 到 localStorage
    - 实现自动跳转
    - _需求: 9.2_

  - [ ] 14.3 实现认证路由守卫
    - 创建 PrivateRoute 组件
    - 检查 token 有效性
    - 未认证时重定向到登录页
    - _需求: 9.1_

  - [ ] 14.4 实现克隆项目管理页面
    - 显示项目列表（表格）
    - 实现创建项目表单
    - 实现编辑项目功能
    - 实现删除项目功能
    - 显示项目状态（pending/cloning/completed/failed）
    - 实现重试按钮（仅失败项目）
    - _需求: 1.1, 1.5, 2.1, 2.3, 3.5_

  - [ ] 14.5 实现监控页面
    - 显示访问日志列表
    - 实现域名过滤
    - 实现时间范围过滤
    - 显示统计数据（总访问次数、独立访问者）
    - 显示访问趋势图表（使用 Chart.js 或 ECharts）
    - _需求: 4.2, 4.3, 4.4, 5.1, 5.2, 5.3_

  - [ ] 14.6 实现系统配置页面
    - 显示所有配置项
    - 实现配置编辑表单
    - 实现配置验证
    - 显示保存成功/失败提示
    - _需求: 6.1, 6.2, 6.4_

  - [ ] 14.7 实现邮件配置页面
    - 显示 SMTP 配置表单
    - 实现测试邮件按钮
    - 显示测试结果
    - _需求: 7.1, 7.2, 7.4_

  - [ ] 14.8 实现功能开关页面
    - 显示所有功能开关
    - 实现开关切换
    - 显示开关描述
    - _需求: 8.1, 8.2_

- [ ] 15. API 文档和部署配置
  - [ ] 15.1 生成 API 文档
    - 使用 FastAPI 自动生成 OpenAPI 文档
    - 添加接口描述和示例
    - _需求: 所有 API 相关需求_

  - [ ] 15.2 创建 Docker 配置
    - 编写 Dockerfile（后端）
    - 编写 Dockerfile（前端）
    - 编写 docker-compose.yml
    - 配置数据库容器
    - 配置环境变量
    - _需求: 10.4_

  - [ ] 15.3 创建部署文档
    - 编写 README.md
    - 说明环境要求
    - 说明安装步骤
    - 说明配置方法
    - _需求: 所有需求_

- [ ] 16. 最终检查点
  - 运行所有测试确保通过
  - 验证所有功能正常工作
  - 检查代码质量和文档完整性
  - 如有问题请询问用户

## 注意事项

- 标记 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
