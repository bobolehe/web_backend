# 网页克隆管理系统 - 启动指南

## 系统功能
- 克隆网页并保存到本地
- 为每个克隆项目启动独立的 HTTP 服务器
- 支持从域名中解析端口（如 `127.0.0.1:7754`）
- 自动管理端口分配（7000-9000 范围）
- 应用重启后自动恢复所有 HTTP 服务器

## 启动步骤

### 1. 激活虚拟环境
```bash
venv\Scripts\activate
```

### 2. 确保所有依赖已安装
```bash
pip install -r requirements.txt
```

### 3. 安装 Playwright 浏览器
```bash
playwright install chromium
```

### 4. 启动应用

**方法一：使用 uvicorn（推荐）**
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8845 --reload
```

**方法二：使用 Python 模块方式**
```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8845 --reload
```

应用将在 `http://0.0.0.0:8845` 启动

> 注意：`--reload` 参数会在代码修改时自动重启，生产环境请去掉此参数

## 使用流程

### 1. 访问前端页面
打开浏览器访问：`http://localhost:8845`

### 2. 注册/登录
- 首次使用需要注册账号
- 使用用户名和密码登录

### 3. 创建项目
- 点击"新建项目"
- 填写项目信息：
  - **项目名称**：自定义名称
  - **域名**：格式如 `127.0.0.1:7754`（端口会从这里解析）
  - **源网址**：要克隆的网页地址
  - **源截图**：可选，上传参考截图

### 4. 克隆网页
- 在项目列表中点击"克隆"按钮
- 系统会：
  1. 使用 Playwright 访问源网址
  2. 保存网页内容到 `cloned_sites/{project_id}/`
  3. 从域名中解析端口（如 `127.0.0.1:7754` → 端口 7754）
  4. 在指定端口启动 HTTP 服务器
  5. 如果指定端口不可用，自动分配 7000-9000 范围内的可用端口

### 5. 访问克隆的网页
克隆完成后，项目列表会显示端口号和"访问"按钮：
- 点击"访问"按钮直接打开
- 或手动访问：`http://127.0.0.1:{端口号}`

## 端口管理说明

### 端口解析规则
- 如果域名包含端口（如 `127.0.0.1:7754`），优先使用该端口
- 如果指定端口不可用，自动分配 7000-9000 范围内的端口
- 端口信息保存在数据库中

### 服务器持久化
- 应用重启后，会自动为所有已完成的项目重启 HTTP 服务器
- 优先使用数据库中保存的端口
- 如果端口不可用，会重新分配

### 服务器管理
- 删除项目时，自动停止对应的 HTTP 服务器
- 应用关闭时，自动停止所有 HTTP 服务器

## 目录结构
```
cloned_sites/
  └── {project_id}/
      └── index.html          # 克隆的网页内容

uploads/
  └── screenshots/            # 上传的截图

clone_management.db           # SQLite 数据库
```

## 常见问题

### Q: 端口被占用怎么办？
A: 系统会自动检测端口可用性，如果指定端口不可用，会在 7000-9000 范围内自动分配可用端口。

### Q: 如何查看服务器日志？
A: 所有日志会输出到控制台，包括：
- 服务器启动/停止信息
- 端口分配信息
- 克隆进度和错误信息

### Q: 克隆失败怎么办？
A: 检查日志中的错误信息，常见原因：
- 源网址无法访问
- 网络超时（默认 60 秒）
- Playwright 浏览器未安装

### Q: 如何修改端口范围？
A: 编辑 `app/services/server_manager.py`：
```python
PORT_START = 7000  # 起始端口
PORT_END = 9000    # 结束端口
```

## 技术栈
- **后端**: FastAPI + SQLAlchemy + Alembic
- **数据库**: SQLite
- **克隆引擎**: Playwright (Chromium)
- **HTTP 服务器**: Python http.server (多线程)
- **前端**: HTML + JavaScript + Bootstrap

## 注意事项
1. 每个项目的 HTTP 服务器运行在独立的守护线程中
2. 服务器使用 `127.0.0.1` 绑定，仅本地访问
3. 克隆任务在后台执行，不会阻塞 API 响应
4. 建议定期清理 `cloned_sites` 目录以节省磁盘空间
